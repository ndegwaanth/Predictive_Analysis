{% extends "layout-two.html" %}

{% block title %}Sales Forecasting | Predictive Analytics{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Moment.js for time formatting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid sales-container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Sales Forecasting Results
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Model Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="metric-card bg-info text-white">
                                <h6>RMSE</h6>
                                <h3>{{ "%.4f"|format(metrics.RMSE) if metrics else 'N/A' }}</h3>
                                <i class="fas fa-ruler"></i>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card bg-success text-white">
                                <h6>AIC</h6>
                                <h3>{{ "%.2f"|format(metrics.AIC) if metrics else 'N/A' }}</h3>
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card bg-warning text-dark">
                                <h6>BIC</h6>
                                <h3>{{ "%.2f"|format(metrics.BIC) if metrics else 'N/A' }}</h3>
                                <i class="fas fa-chart-pie"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Main Visualization -->
                    <div class="visualization-card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Actual vs Predicted Values</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="salesChart" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Forecast Visualization -->
                    <div class="visualization-card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Future Forecast</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="forecastChart" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Model Summary -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">ARIMA Model Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="model-summary">
                                <pre>{{ model_summary if model_summary else 'No model summary available' }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.model_training') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Model Selection
                        </a>
                        <button class="btn btn-primary" onclick="exportResults()">
                            <i class="fas fa-file-export me-2"></i>Export Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Export Options -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Export Forecast Results</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Export Format:</label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                        <option value="png">PNG Image</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Date Range:</label>
                    <div class="input-group">
                        <input type="date" class="form-control" id="startDate">
                        <span class="input-group-text">to</span>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmExport()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts with data passed from Flask
    const graphs = {{ graphs|tojson|safe }};
    
    // Render Sales Chart
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: graphs.actual_vs_predicted.labels,
            datasets: [
                {
                    label: 'Actual Sales',
                    data: graphs.actual_vs_predicted.actual,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'Predicted Sales',
                    data: graphs.actual_vs_predicted.predicted,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Actual vs Predicted Sales'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time Period'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Sales Value'
                    }
                }
            }
        }
    });

    // Render Forecast Chart
    const forecastCtx = document.getElementById('forecastChart').getContext('2d');
    new Chart(forecastCtx, {
        type: 'line',
        data: {
            labels: graphs.forecast.labels,
            datasets: [
                {
                    label: 'Historical Sales',
                    data: graphs.forecast.historical,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'Forecasted Sales',
                    data: graphs.forecast.forecast,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    fill: true,
                    borderDash: [5, 5]
                },
                {
                    label: 'Confidence Interval (95%)',
                    data: graphs.forecast.upper_bound,
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderDash: [3, 3],
                    fill: 1
                },
                {
                    label: '',
                    data: graphs.forecast.lower_bound,
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderDash: [3, 3],
                    fill: '-1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Sales Forecast with Confidence Interval'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Future Time Periods'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Sales Value'
                    }
                }
            }
        }
    });
});

function exportResults() {
    // Show export modal
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    exportModal.show();
}

function confirmExport() {
    const format = document.getElementById('exportFormat').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // Here I would typically make an AJAX call to my backend
    // to handle the export in the selected format
    alert(`Exporting data as ${format} from ${startDate} to ${endDate}`);
    
    // Close the modal
    const exportModal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    exportModal.hide();
}
</script>
{% endblock %}
